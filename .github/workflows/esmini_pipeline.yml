name: Esmini Scenario Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  run-esmini-scenario:
    # If later you connect your Fever machine as a self-hosted runner,
    # change this to: runs-on: [ self-hosted ]
    runs-on: ubuntu-latest

    steps:
      # 1) Get the repo files (xosc + xodr) onto the runner
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Show that the scenario and road files exist
      - name: List scenario and road files
        run: |
          echo "Current directory:"
          pwd
          echo "Files:"
          ls -R
          echo "Checking required files..."
          test -f scenarios/deepa_speed_task.xosc
          test -f roads/straight_500m.xodr
          echo "Scenario and road files are present."

      # 3) Run esmini with the scenario (path must be updated for your environment)
      - name: Run esmini scenario
        run: |
          # TODO: change ESMINI_ROOT to the actual install path of esmini
          # For example, on your Fever Windows agent you might have C:\tools\esmini
          # On Linux it might be /opt/esmini
          ESMINI_ROOT="${ESMINI_ROOT:-/opt/esmini}"

          echo "Using esmini from: $ESMINI_ROOT"

          "$ESMINI_ROOT/bin/esmini" \
            --osc scenarios/deepa_speed_task.xosc \
            --window 0 \
            --info_text 1 \
            --logfile esmini_log.txt
        shell: bash

      # 4) Upload the esmini log as a pipeline artifact
      - name: Upload esmini log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: esmini-log
          path: esmini_log.txt
